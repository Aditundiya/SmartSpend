rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the profile
    // Profile ID should match the authenticated user's UID
    function isProfileOwner(profileId) {
      return isAuthenticated() && request.auth.uid == profileId;
    }
    
    // Check if user is the partner of the profile
    function isPartner(profileId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/profiles/$(profileId)).data.partnerUid == request.auth.uid;
    }
    
    function hasAccess(profileId) {
      return isProfileOwner(profileId) || isPartner(profileId);
    }
    
    // Profiles collection
    match /profiles/{profileId} {
      // Allow specific document read for authenticated users to enable discovery for linking
      allow get: if isAuthenticated();
      // Re-strict listing to owners and partners
      allow list: if hasAccess(profileId);
      
      // Allow update for:
      // 1. Owner (full access)
      // 2. Authenticated user setting partnerUid to self (linking)
      // 3. Authenticated user clearing partnerUid if they are the current partner (unlinking)
      allow update: if isProfileOwner(profileId) || 
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['partnerUid']) &&
                       (
                         (request.resource.data.partnerUid == request.auth.uid && (resource.data.partnerUid == null || resource.data.partnerUid == "" || resource.data.partnerUid == request.auth.uid)) ||
                         (request.resource.data.partnerUid == "" || !('partnerUid' in request.resource.data)) && (resource.data.partnerUid == request.auth.uid)
                       ));
      
      // Allow creation only for owner
      allow create: if isProfileOwner(profileId);
      
      match /expenses/{expenseId} {
        allow read, write: if hasAccess(profileId);
      }
      
      match /incomes/{incomeId} {
        allow read, write: if hasAccess(profileId);
      }
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
